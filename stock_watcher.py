amplitude_date = "20201225"
amplitude_stocks = """
------- RESULTS --------
------------------------
TURNOVER:-------------------------------------------------------
美丽生态　　　　　　    000010.SZ       3.91            0.03            建筑工程　　　　　　
3.78    3.81    3.84    3.88    3.91    3.94    3.98    4.01    4.04
深圳能源　　　　　　    000027.SZ       6.38            0.07            火力发电　　　　　　
6.09    6.17    6.24    6.31    6.38    6.45    6.52    6.59    6.67
东旭蓝天　　　　　　    000040.SZ       3.43            0.04            新型电力　　　　　　
3.25    3.30    3.34    3.39    3.43    3.47    3.52    3.56    3.61
南京公用　　　　　　    000421.SZ       6.62            0.10            供气供热　　　　　　
6.22    6.32    6.42    6.52    6.62    6.72    6.82    6.92    7.02
长航凤凰　　　　　　    000520.SZ       3.49            0.03            水运　　　　　　　　
3.36    3.39    3.42    3.46    3.49    3.52    3.56    3.59    3.62
粤电力A　　　　　　     000539.SZ       4.05            0.04            火力发电　　　　　　
3.89    3.93    3.97    4.01    4.05    4.09    4.13    4.17    4.21
建投能源　　　　　　    000600.SZ       5.89            0.06            火力发电　　　　　　
5.67    5.72    5.78    5.83    5.89    5.95    6.00    6.06    6.11
中色股份　　　　　　    000758.SZ       5.31            0.08            铅锌　　　　　　　　
5.01    5.08    5.16    5.23    5.31    5.39    5.46    5.54    5.61
湖北能源　　　　　　    000883.SZ       3.95            0.03            火力发电　　　　　　
3.83    3.86    3.89    3.92    3.95    3.98    4.01    4.04    4.07
闽东电力　　　　　　    000993.SZ       7.43            0.11            水力发电　　　　　　
6.98    7.09    7.20    7.32    7.43    7.54    7.66    7.77    7.88
兔宝宝　　　　　　　    002043.SZ       8.97            0.08            其他建材　　　　　　
8.64    8.72    8.81    8.89    8.97    9.05    9.13    9.22    9.30
海得控制　　　　　　    002184.SZ       14.07           0.15            软件服务　　　　　　
13.45   13.61   13.76   13.92   14.07   14.22   14.38   14.53   14.69
惠博普　　　　　　　    002554.SZ       2.7             0.03            石油开采　　　　　　
2.59    2.62    2.65    2.67    2.70    2.73    2.75    2.78    2.81
北玻股份　　　　　　    002613.SZ       4.44            0.05            专用机械　　　　　　
4.26    4.30    4.35    4.39    4.44    4.49    4.53    4.58    4.62
上海电力　　　　　　    600021.SH       7.34            0.05            火力发电　　　　　　
7.12    7.18    7.23    7.29    7.34    7.39    7.45    7.50    7.56
明星电力　　　　　　    600101.SH       6.08            0.05            水力发电　　　　　　
5.87    5.92    5.98    6.03    6.08    6.13    6.18    6.24    6.29
三峡水利　　　　　　    600116.SH       8.57            0.07            水力发电　　　　　　
8.29    8.36    8.43    8.50    8.57    8.64    8.71    8.78    8.85
西部资源　　　　　　    600139.SH       3.83            0.07            综合类　　　　　　　
3.57    3.63    3.70    3.76    3.83    3.90    3.96    4.03    4.09
动力源　　　　　　　    600405.SH       5.97            0.07            电气设备　　　　　　
5.68    5.75    5.83    5.90    5.97    6.04    6.11    6.19    6.26
亿晶光电　　　　　　    600537.SH       5.67            0.07            电气设备　　　　　　
5.40    5.47    5.53    5.60    5.67    5.74    5.81    5.87    5.94
国新能源　　　　　　    600617.SH       4.9             0.05            供气供热　　　　　　
4.69    4.74    4.80    4.85    4.90    4.95    5.00    5.06    5.11
大众公用　　　　　　    600635.SH       4.27            0.03            供气供热　　　　　　
4.13    4.17    4.20    4.24    4.27    4.30    4.34    4.37    4.41
乐山电力　　　　　　    600644.SH       6.14            0.07            水力发电　　　　　　
5.84    5.92    5.99    6.07    6.14    6.21    6.29    6.36    6.44
通宝能源　　　　　　    600780.SH       3.8             0.05            火力发电　　　　　　
3.62    3.66    3.71    3.75    3.80    3.85    3.89    3.94    3.98
内蒙华电　　　　　　    600863.SH       2.62            0.02            火力发电　　　　　　
2.55    2.57    2.59    2.60    2.62    2.64    2.65    2.67    2.69
广安爱众　　　　　　    600979.SH       3.44            0.04            水力发电　　　　　　
3.28    3.32    3.36    3.40    3.44    3.48    3.52    3.56    3.60
文山电力　　　　　　    600995.SH       8.32            0.08            水力发电　　　　　　
8.00    8.08    8.16    8.24    8.32    8.40    8.48    8.56    8.64
中原证券　　　　　　    601375.SH       5.61            0.05            证券　　　　　　　　
5.39    5.45    5.50    5.56    5.61    5.66    5.72    5.77    5.83
音飞储存　　　　　　    603066.SH       9.26            0.13            仓储物流　　　　　　
8.74    8.87    9.00    9.13    9.26    9.39    9.52    9.65    9.78
神马电力　　　　　　    603530.SH       23.98           0.34            电气设备　　　　　　
22.62   22.96   23.30   23.64   23.98   24.32   24.66   25.00   25.34
顾家家居　　　　　　    603816.SH       70.64           0.75            家居用品　　　　　　
67.63   68.38   69.13   69.89   70.64   71.39   72.15   72.90   73.65
百合花　　　　　　　    603823.SH       14.77           0.14            染料涂料　　　　　　
14.20   14.34   14.49   14.63   14.77   14.91   15.05   15.20   15.34
MACDGOLDCROSSMINUS:-------------------------------------------------------
中金岭南　　　　　　    000060.SZ       4.87            0.05            铅锌　　　　　　　　
4.65    4.71    4.76    4.82    4.87    4.92    4.98    5.03    5.09
焦作万方　　　　　　    000612.SZ       7.22            0.10            铝　　　　　　　　　
6.83    6.93    7.02    7.12    7.22    7.32    7.42    7.51    7.61
铜陵有色　　　　　　    000630.SZ       2.6             0.03            铜　　　　　　　　　
2.49    2.52    2.55    2.57    2.60    2.63    2.65    2.68    2.71
五矿稀土　　　　　　    000831.SZ       13.7            0.18            小金属　　　　　　　
12.99   13.17   13.34   13.52   13.70   13.88   14.06   14.23   14.41
华铁股份　　　　　　    000976.SZ       5.35            0.07            运输设备　　　　　　
5.08    5.15    5.21    5.28    5.35    5.42    5.49    5.55    5.62
博云新材　　　　　　    002297.SZ       7.44            0.08            矿物制品　　　　　　
7.13    7.21    7.29    7.36    7.44    7.52    7.59    7.67    7.75
天原集团　　　　　　    002386.SZ       5.7             0.06            化工原料　　　　　　
5.45    5.51    5.58    5.64    5.70    5.76    5.82    5.89    5.95
荣盛石化　　　　　　    002493.SZ       27.25           0.38            化纤　　　　　　　　
25.75   26.12   26.50   26.87   27.25   27.63   28.00   28.38   28.75
登云股份　　　　　　    002715.SZ       17.05           0.21            汽车配件　　　　　　
16.21   16.42   16.63   16.84   17.05   17.26   17.47   17.68   17.89
全柴动力　　　　　　    600218.SH       9.69            0.11            农用机械　　　　　　
9.24    9.35    9.46    9.58    9.69    9.80    9.92    10.03   10.14
盛和资源　　　　　　    600392.SH       8.98            0.13            小金属　　　　　　　
8.47    8.60    8.73    8.85    8.98    9.11    9.23    9.36    9.49
华鲁恒升　　　　　　    600426.SH       37.91           0.52            农药化肥　　　　　　
35.84   36.36   36.88   37.39   37.91   38.43   38.94   39.46   39.98
金瑞矿业　　　　　　    600714.SH       5.48            0.07            化工原料　　　　　　
5.22    5.28    5.35    5.41    5.48    5.55    5.61    5.68    5.74
智慧能源　　　　　　    600869.SH       3.6             0.04            电气设备　　　　　　
3.43    3.47    3.51    3.56    3.60    3.64    3.69    3.73    3.77
株冶集团　　　　　　    600961.SH       7.59            0.10            铅锌　　　　　　　　
7.18    7.28    7.38    7.49    7.59    7.69    7.80    7.90    8.00
中远海发　　　　　　    601866.SH       3.0             0.04            水运　　　　　　　　
2.83    2.87    2.92    2.96    3.00    3.04    3.08    3.13    3.17
紫金矿业　　　　　　    601899.SH       9.27            0.11            黄金　　　　　　　　
8.84    8.95    9.06    9.16    9.27    9.38    9.48    9.59    9.70
尚纬股份　　　　　　    603333.SH       5.82            0.06            电气设备　　　　　　
5.57    5.63    5.69    5.76    5.82    5.88    5.95    6.01    6.07
文灿股份　　　　　　    603348.SH       30.0            0.45            汽车配件　　　　　　
28.18   28.64   29.09   29.55   30.00   30.45   30.91   31.36   31.82
HAMMERPLUS:-------------------------------------------------------
靖远煤电　　　　　　    000552.SZ       3.26            0.06            煤炭开采　　　　　　
3.04    3.09    3.15    3.20    3.26    3.32    3.37    3.43    3.48
华孚时尚　　　　　　    002042.SZ       4.36            0.06            纺织　　　　　　　　
4.11    4.17    4.23    4.30    4.36    4.42    4.49    4.55    4.61
劲嘉股份　　　　　　    002191.SZ       9.5             0.08            广告包装　　　　　　
9.17    9.25    9.34    9.42    9.50    9.58    9.66    9.75    9.83
大连圣亚　　　　　　    600593.SH       19.59           0.23            旅游服务　　　　　　
18.68   18.91   19.13   19.36   19.59   19.82   20.05   20.27   20.50
广信股份　　　　　　    603599.SH       23.16           0.27            农药化肥　　　　　　
22.09   22.36   22.63   22.89   23.16   23.43   23.69   23.96   24.23
巴比食品　　　　　　    605338.SH       38.79           0.54            食品　　　　　　　　
36.64   37.18   37.71   38.25   38.79   39.33   39.87   40.40   40.94
HAMMER:-------------------------------------------------------
长安汽车　　　　　　    000625.SZ       22.07           0.35            汽车整车　　　　　　
20.69   21.03   21.38   21.72   22.07   22.42   22.76   23.11   23.45
中航飞机　　　　　　    000768.SZ       33.15           0.52            航空　　　　　　　　
31.08   31.60   32.12   32.63   33.15   33.67   34.18   34.70   35.22
中鼎股份　　　　　　    000887.SZ       11.81           0.13            橡胶　　　　　　　　
11.27   11.41   11.54   11.68   11.81   11.94   12.08   12.21   12.35
威尔泰　　　　　　　    002058.SZ       13.17           0.30            电器仪表　　　　　　
11.96   12.26   12.56   12.87   13.17   13.47   13.78   14.08   14.38
龙蟒佰利　　　　　　    002601.SZ       30.82           0.43            化工原料　　　　　　
29.11   29.54   29.97   30.39   30.82   31.25   31.67   32.10   32.53
姚记科技　　　　　　    002605.SZ       23.36           0.26            互联网　　　　　　　
22.31   22.57   22.83   23.10   23.36   23.62   23.89   24.15   24.41
福建金森　　　　　　    002679.SZ       10.55           0.12            林业　　　　　　　　
10.08   10.20   10.31   10.43   10.55   10.67   10.79   10.90   11.02
龙津药业　　　　　　    002750.SZ       8.51            0.11            中成药　　　　　　　
8.06    8.17    8.29    8.40    8.51    8.62    8.73    8.85    8.96
中装建设　　　　　　    002822.SZ       6.57            0.07            装修装饰　　　　　　
6.27    6.35    6.42    6.50    6.57    6.64    6.72    6.79    6.87
意华股份　　　　　　    002897.SZ       25.71           0.26            元器件　　　　　　　
24.66   24.92   25.19   25.45   25.71   25.97   26.23   26.50   26.76
恒力石化　　　　　　    600346.SH       28.2            0.34            化纤　　　　　　　　
26.83   27.17   27.51   27.86   28.20   28.54   28.89   29.23   29.57
航发科技　　　　　　    600391.SH       23.77           0.31            航空　　　　　　　　
22.55   22.85   23.16   23.46   23.77   24.08   24.38   24.69   24.99
扬农化工　　　　　　    600486.SH       131.3           1.60            农药化肥　　　　　　
124.90  126.50  128.10  129.70  131.30  132.90  134.50  136.10  137.70
贵航股份　　　　　　    600523.SH       15.11           0.15            汽车配件　　　　　　
14.51   14.66   14.81   14.96   15.11   15.26   15.41   15.56   15.71
大连圣亚　　　　　　    600593.SH       19.59           0.23            旅游服务　　　　　　
18.68   18.91   19.13   19.36   19.59   19.82   20.05   20.27   20.50
中船防务　　　　　　    600685.SH       25.25           0.27            船舶　　　　　　　　
24.18   24.45   24.71   24.98   25.25   25.52   25.79   26.05   26.32
中航重机　　　　　　    600765.SH       20.04           0.29            航空　　　　　　　　
18.88   19.17   19.46   19.75   20.04   20.33   20.62   20.91   21.20
中房股份　　　　　　    600890.SH       5.05            0.08            区域地产　　　　　　
4.73    4.81    4.89    4.97    5.05    5.13    5.21    5.29    5.37
合盛硅业　　　　　　    603260.SH       40.5            0.54            化工原料　　　　　　
38.33   38.87   39.41   39.96   40.50   41.04   41.59   42.13   42.67
丰山集团　　　　　　    603810.SH       23.3            0.23            农药化肥　　　　　　
22.40   22.62   22.85   23.07   23.30   23.53   23.75   23.98   24.20
麦迪科技　　　　　　    603990.SH       32.6            0.43            软件服务　　　　　　
30.87   31.31   31.74   32.17   32.60   33.03   33.46   33.89   34.33
MACDGOLDCROSS:-------------------------------------------------------
华峰氨纶　　　　　　    002064.SZ       9.75            0.14            化纤　　　　　　　　
9.21    9.34    9.48    9.61    9.75    9.89    10.02   10.16   10.29
露天煤业　　　　　　    002128.SZ       11.37           0.15            煤炭开采　　　　　　
10.77   10.92   11.07   11.22   11.37   11.52   11.67   11.82   11.97
东方锆业　　　　　　    002167.SZ       5.7             0.06            小金属　　　　　　　
5.45    5.51    5.58    5.64    5.70    5.76    5.82    5.89    5.95
巨星科技　　　　　　    002444.SZ       28.92           0.38            轻工机械　　　　　　
27.39   27.78   28.16   28.54   28.92   29.30   29.68   30.06   30.45
三维工程　　　　　　    002469.SZ       6.04            0.07            建筑工程　　　　　　
5.78    5.84    5.91    5.97    6.04    6.11    6.17    6.24    6.30
雪人股份　　　　　　    002639.SZ       6.9             0.09            专用机械　　　　　　
6.53    6.62    6.72    6.81    6.90    6.99    7.08    7.18    7.27
长鹰信质　　　　　　    002664.SZ       14.91           0.20            汽车配件　　　　　　
14.10   14.30   14.50   14.71   14.91   15.11   15.32   15.52   15.72
博杰股份　　　　　　    002975.SZ       119.66          1.32            专用机械　　　　　　
114.38  115.70  117.02  118.34  119.66  120.98  122.30  123.62  124.94
北方稀土　　　　　　    600111.SH       13.26           0.21            小金属　　　　　　　
12.43   12.64   12.85   13.05   13.26   13.47   13.67   13.88   14.09
动力源　　　　　　　    600405.SH       5.97            0.07            电气设备　　　　　　
5.68    5.75    5.83    5.90    5.97    6.04    6.11    6.19    6.26
三友化工　　　　　　    600409.SH       9.29            0.13            化工原料　　　　　　
8.77    8.90    9.03    9.16    9.29    9.42    9.55    9.68    9.81
中远海特　　　　　　    600428.SH       4.58            0.09            水运　　　　　　　　
4.23    4.32    4.41    4.49    4.58    4.67    4.75    4.84    4.93
驰宏锌锗　　　　　　    600497.SH       4.94            0.08            铅锌　　　　　　　　
4.64    4.71    4.79    4.86    4.94    5.02    5.09    5.17    5.24
豫光金铅　　　　　　    600531.SH       5.9             0.07            铅锌　　　　　　　　
5.60    5.68    5.75    5.83    5.90    5.97    6.05    6.12    6.20
八一钢铁　　　　　　    600581.SH       3.84            0.05            普钢　　　　　　　　
3.64    3.69    3.74    3.79    3.84    3.89    3.94    3.99    4.04
金牛化工　　　　　　    600722.SH       4.56            0.06            化工原料　　　　　　
4.31    4.37    4.43    4.50    4.56    4.62    4.69    4.75    4.81
广安爱众　　　　　　    600979.SH       3.44            0.04            水力发电　　　　　　
3.28    3.32    3.36    3.40    3.44    3.48    3.52    3.56    3.60
淮北矿业　　　　　　    600985.SH       11.49           0.14            煤炭开采　　　　　　
10.93   11.07   11.21   11.35   11.49   11.63   11.77   11.91   12.05
怡球资源　　　　　　    601388.SH       3.18            0.05            铝　　　　　　　　　
2.99    3.04    3.08    3.13    3.18    3.23    3.28    3.32    3.37
中远海控　　　　　　    601919.SH       11.48           0.18            水运　　　　　　　　
10.76   10.94   11.12   11.30   11.48   11.66   11.84   12.02   12.20
松发股份　　　　　　    603268.SH       17.55           0.21            陶瓷　　　　　　　　
16.71   16.92   17.13   17.34   17.55   17.76   17.97   18.18   18.39
清源股份　　　　　　    603628.SH       10.75           0.15            电气设备　　　　　　
10.16   10.30   10.45   10.60   10.75   10.90   11.05   11.20   11.34
"""

import os
import re
import requests
import json
import time
from stock import Stock

def get_all_stocks():
    mas = re.findall('\d{6}\.S[H|Z]', amplitude_stocks)
    results = []
    for ma in mas:
        if 'SH' in ma:
            results.append('0' + ma[0:6])
        else:  
            results.append('1' + ma[0:6])
    return results

def get_real_price(mas):
    url = "https://api.money.126.net/data/feed/%s?callback=a" % (",".join(mas))
    response = requests.get(url)
    content = response.content.decode('utf-8')
    stocks = json.loads(content[2:-2])
    results = []
    for s in stocks:
        results.append(stocks[s])
    return results

def get_average_amplitude_dict(stocks):
    average_amplitude_dict = {}
    for stock in stocks:
        stk = Stock(stock['name'], stock['symbol'] + '.' + stock['type'], amplitude_date)
        if stk.init():
            average_amplitude_dict[stock['name']] = stk.get_average_amplitude(7)
    return average_amplitude_dict

def show_current_price(stocks):
    print("{0:<10}\t{1:{13}<8}\t{2:<10}\t{3:<10}\t{4:<10}\t{5:<10}\t{6:<10}\t{7:<10}\t{8:<10}\t{9:<10}\t{10:<10}\t{11:<10}\t{12:<10}".format(
        "CODE", "NAME", "PRE_CLOSE", "OPEN", "HIGH", "LOW", "AVG_AMP", "AMP", "PRICE", "B1", "B2", "B3", "B4", chr(12288)))
    for stock in stocks:    
        # if '603002.SH' != stock['symbol'] + '.' + stock['type']:
        #     continue
        average_amplitude = 100 * average_amplitude_dict[stock['name']]    
        current_amplitude = 100 * (stock['high'] - stock['low']) / stock['yestclose']

        b1 = stock['yestclose'] * (1 - average_amplitude / 100 * 0.25)
        b2 = stock['yestclose'] * (1 - average_amplitude / 100 * 0.5)
        b3 = stock['yestclose'] * (1 - average_amplitude / 100 * 0.75)
        b4 = stock['yestclose'] * (1 - average_amplitude / 100 * 1)
        delta = (b1 - b2) / 2
        current_price = stock['price']

        info = "{0:<10}\t{1:{13}<6}\t{2:<10}\t{3:<10}\t{4:<10}\t{5:<10}\t{6:<10}\t{7:<10}\t{8:<10}\t{9:<10}\t{10:<10}\t{11:<10}\t{12:<10}".format(
            stock['symbol'] + '.' + stock['type'], 
            stock['name'].replace(' ', ''),
            "%.2f" % (stock['yestclose']),
            "%.2f" % (stock['open']),
            "%.2f" % (stock['high']),
            "%.2f" % (stock['low']),
            "%.2f" % (average_amplitude),
            "%.2f" % (current_amplitude),
            "%.2f" % (current_price),
            "%.2f" % (b1),
            "%.2f" % (b2),
            "%.2f" % (b3),
            "%.2f" % (b4),
            chr(12288))

        if b1 + delta > current_price > b1 - delta:
            print_red(info)
        elif b2 + delta > current_price > b2 - delta:
            print_green(info)
        elif b3 + delta > current_price > b3 - delta:
            print_yellow(info)
        elif b4 + delta > current_price > b4 - delta:
            print_blue(info)
        else:
            print_normal(info)
    # print(time.perf_counter())

def print_normal(s):
    print(s)

def print_red(s):
    print(f"\033[0;31;40m%s\033[0m" % (s))

def print_green(s):
    print(f"\033[0;32;40m%s\033[0m" % (s))

def print_yellow(s):
    print(f"\033[0;33;40m%s\033[0m" % (s))

def print_blue(s):
    print(f"\033[0;34;40m%s\033[0m" % (s))

if __name__ == '__main__':

    # get all stocks and real price
    mas = get_all_stocks()
    stocks = get_real_price(mas)
    
    # get average amplitude dict
    average_amplitude_dict = get_average_amplitude_dict(stocks)
    # print(average_amplitude_dict)

    while True:
        os.system("clear")
        show_current_price(stocks)
        time.sleep(5)
        stocks = get_real_price(mas)
